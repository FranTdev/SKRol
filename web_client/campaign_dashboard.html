<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Campa√±a | Stephen King RPG</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;700&family=Metamorphous&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-glow: rgba(183, 28, 28, 0.6);
            --bg-dark: #0a0a0a;
            --card-bg: #1a1a1a;
            --accent: #d32f2f;
            --tabs-bg: #121212;
        }

        body {
            background-color: var(--bg-dark);
            color: #e0e0e0;
            font-family: 'Crimson Pro', serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            padding: 1.5rem;
            text-align: center;
            background: linear-gradient(180deg, #1a1515 0%, transparent 100%);
            border-bottom: 1px solid rgba(211, 47, 47, 0.2);
            position: relative;
        }

        .back-btn {
            position: absolute;
            left: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            text-decoration: none;
            color: var(--accent);
            font-family: 'Metamorphous', cursive;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        h1 {
            font-family: 'Metamorphous', cursive;
            color: var(--accent);
            text-shadow: 0 0 10px var(--primary-glow);
            margin: 0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            justify-content: center;
            background: var(--tabs-bg);
            border-bottom: 1px solid #333;
        }

        .tab-btn {
            padding: 1rem 2rem;
            background: none;
            border: none;
            color: #888;
            font-family: 'Metamorphous', cursive;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
        }

        .tab-btn:hover {
            color: #fff;
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            background: rgba(211, 47, 47, 0.05);
        }

        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
            flex-grow: 1;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Common Elements */
        .card {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .btn {
            background: rgba(211, 47, 47, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 0.6rem 1.2rem;
            font-family: 'Metamorphous', cursive;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.3s;
        }

        .btn:hover {
            background: var(--accent);
            color: white;
        }

        /* Ranking Styles for Shining */
        .rank-s {
            color: #ffeb3b !important;
            text-shadow: 0 0 15px #ffeb3b, 0 0 25px rgba(255, 235, 59, 0.5);
            font-weight: bold;
            animation: supreme-glow 2s infinite alternate;
        }

        .rank-a {
            color: #9c27b0 !important;
            text-shadow: 0 0 10px #9c27b0;
            font-weight: bold;
            animation: prestige-glow 3s infinite alternate;
        }

        .rank-b {
            color: #f44336 !important;
            text-shadow: 0 0 8px #f44336;
            font-weight: bold;
        }

        .rank-c {
            color: #00bcd4 !important;
            text-shadow: 0 0 5px #00bcd4;
        }

        .rank-d {
            color: #757575 !important;
            opacity: 0.8;
        }

        @keyframes supreme-glow {
            from {
                text-shadow: 0 0 10px #ffeb3b, 0 0 20px rgba(255, 235, 59, 0.5);
            }

            to {
                text-shadow: 0 0 20px #ffeb3b, 0 0 40px rgba(255, 235, 59, 0.8);
            }
        }

        @keyframes prestige-glow {
            from {
                text-shadow: 0 0 5px #9c27b0;
            }

            to {
                text-shadow: 0 0 15px #9c27b0;
            }
        }

        /* Adjustments */
        .search-box {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .search-box input {
            flex-grow: 1;
            background: #2a2a2a;
            border: 1px solid #444;
            padding: 0.8rem;
            color: white;
            border-radius: 4px;
        }

        .search-results {
            margin-bottom: 2rem;
            border: 1px solid #333;
            border-radius: 4px;
            display: none;
        }

        .result-item {
            padding: 0.8rem;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .participant-list {
            display: grid;
            gap: 1rem;
        }

        .participant-item {
            background: #111;
            padding: 1rem;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Personajes Styles */
        .char-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .char-card {
            background: #1a1a1a;
            border-left: 4px solid var(--accent);
            padding: 1rem;
            border-radius: 4px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--accent);
        }

        .form-row {
            margin-bottom: 1rem;
        }

        .form-row label {
            display: block;
            margin-bottom: 0.3rem;
            color: #888;
        }

        .form-row input,
        .form-row select,
        .form-row textarea {
            width: 100%;
            padding: 0.6rem;
            background: #222;
            border: 1px solid #444;
            color: white;
            border-radius: 4px;
        }

        /* Detailed sheet */
        .detailed-sheet {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            z-index: 1500;
            overflow-y: auto;
            padding: 2rem;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-box {
            background: #111;
            padding: 1rem;
            border: 1px solid #333;
            text-align: center;
            border-radius: 4px;
        }

        .stat-box label {
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
        }

        .stat-box div {
            font-size: 1.5rem;
            font-family: 'Metamorphous', cursive;
            color: var(--accent);
        }

        .shining-machine-panel {
            background: linear-gradient(45deg, #1a0505, #05051a);
            border: 1px solid #d32f2f;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .inventory-section {
            margin-top: 2rem;
            border-top: 1px solid #333;
            padding-top: 1rem;
        }

        .item-list {
            display: grid;
            gap: 0.5rem;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            background: #1a1a1a;
            padding: 0.5rem 1rem;
            border-radius: 4px;
        }

        /* Death Status */
        .char-card.dead {
            filter: grayscale(1);
            opacity: 0.7;
            border-left-color: #444;
        }

        .detailed-sheet textarea:read-only {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid #222;
        }

        .admin-only {
            display: none;
        }

        /* Pending Death Glow & Pulsing Aura */
        @keyframes death-aura {
            0% {
                box-shadow: 0 0 10px rgba(183, 28, 28, 0.3);
                border-color: #b71c1c88;
            }

            50% {
                box-shadow: 0 0 30px rgba(183, 28, 28, 0.7);
                border-color: #b71c1c;
            }

            100% {
                box-shadow: 0 0 10px rgba(183, 28, 28, 0.3);
                border-color: #b71c1c88;
            }
        }

        /* NEW STATES: TRASCENDIDO & DEAD REFINED */
        .char-card.dead {
            border: 2px solid #600 !important;
            background: linear-gradient(135deg, #1a0000 0%, #000 100%);
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.9);
            filter: grayscale(0.8) contrast(1.1);
            position: relative;
        }

        .char-card.dead::before {
            content: 'DEFUNCION';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            font-size: 3rem;
            color: #f00;
            opacity: 0.15;
            font-weight: bold;
            pointer-events: none;
            border: 4px solid #f00;
            padding: 0.5rem;
        }

        .char-card.pending-death {
            border: 2px solid #b71c1c !important;
            animation: death-aura 1.5s infinite ease-in-out;
            background: linear-gradient(0deg, rgba(183, 28, 28, 0.1), transparent);
        }

        .char-card.transcended {
            border: 2px solid #ffeb3b !important;
            background: linear-gradient(135deg, #2b2b00 0%, #000 100%);
            box-shadow: 0 0 25px rgba(255, 235, 59, 0.3);
            animation: transcendental-glow 4s infinite ease-in-out;
            position: relative;
        }

        .char-card.transcended::before {
            content: '‚ú®';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            opacity: 0.1;
            pointer-events: none;
        }

        @keyframes transcendental-glow {
            0% {
                box-shadow: 0 0 15px rgba(255, 235, 59, 0.2);
                border-color: #ffeb3b88;
            }

            50% {
                box-shadow: 0 0 35px rgba(255, 235, 59, 0.5);
                border-color: #ffeb3b;
            }

            100% {
                box-shadow: 0 0 15px rgba(255, 235, 59, 0.2);
                border-color: #ffeb3b88;
            }
        }

        .limit-input {
            width: 50px;
            background: #222;
            border: 1px solid #444;
            color: white;
            padding: 0.3rem;
            border-radius: 4px;
            text-align: center;
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(1);
        }
    </style>
</head>

<body>
    <header>
        <a href="campaigns.html" class="back-btn">‚Üê Mundos</a>
        <h1 id="campaign-title">Cargando...</h1>
        <div id="campaign-admin" style="font-size: 0.8rem; color: #888; margin-top: 0.5rem;">Cargando admin...</div>
    </header>

    <nav class="tabs">
        <button class="tab-btn active" onclick="showTab('resumen')">Resumen</button>
        <button id="participantes-tab-btn" class="tab-btn" onclick="showTab('participantes')">Participantes</button>
        <button class="tab-btn" onclick="showTab('personajes')">Personajes</button>
        <button id="gestion-tab-btn" class="tab-btn admin-only" onclick="showTab('gestion')">Gesti√≥n</button>
        <button class="tab-btn" onclick="showTab('manual')">Manual</button>
    </nav>

    <div class="container">
        <!-- Tab: Resumen -->
        <div id="resumen" class="tab-content active">
            <div class="card">
                <h2>Estado del Mundo</h2>
                <p id="campaign-desc">Esta es tu campa√±a en el nivel actual del Haz.</p>
                <div id="campaign-date"></div>
            </div>
        </div>

        <!-- Tab: Participantes -->
        <div id="participantes" class="tab-content">
            <div class="card">
                <h2>Invocar Compa√±eros</h2>
                <div id="search-panel">
                    <div class="search-box">
                        <input type="text" id="user-search-input" placeholder="Buscar por nombre de usuario...">
                        <button id="search-btn" class="btn">Buscar</button>
                    </div>
                </div>
                <div id="search-results" class="search-results"></div>

                <h3>C√≠rculo Actual</h3>
                <div id="participant-list" class="participant-list">
                    <!-- Participantes din√°micos -->
                </div>
            </div>
        </div>

        <!-- Tab: Personajes -->
        <div id="personajes" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2>Hojas de Personaje</h2>
                <button id="create-char-btn" class="btn">Nuevo Personaje</button>
            </div>
            <div id="char-list" class="char-grid">
                <!-- Personajes din√°micos -->
            </div>
        </div>

        <!-- Tab: Manual -->
        <div id="manual" class="tab-content">
            <!-- ... existing manual content ... -->
            <div class="card" style="text-align: center; padding: 3rem;">
                <h2 style="font-family: 'Metamorphous', cursive; font-size: 2rem;">EL MANUAL DEL HAZ</h2>
                <p>Todo lo que un pistolero o un maestro necesita saber para sobrevivir.</p>
                <a href="#" class="btn" style="display: inline-block; margin-top: 2rem; padding: 1rem 2rem;">Abrir
                    Manual Completo (PDF)</a>
            </div>
        </div>

        <!-- Tab: Gesti√≥n (Admin Only) -->
        <div id="gestion" class="tab-content">
            <div class="card">
                <h2>Reglas del Mundo</h2>
                <textarea id="campaign-rules-input"
                    style="width: 100%; min-height: 100px; background: #111; border: 1px solid #333; color: white; padding: 0.5rem; margin-bottom: 1rem;"
                    placeholder="Define aqu√≠ las reglas generales..."></textarea>
                <div style="text-align: right;">
                    <button class="btn btn-small" onclick="saveCampaignGeneralSettings()">Guardar Reglas</button>
                </div>
            </div>

            <div class="card">
                <h2>El Resplandor: Configuraci√≥n</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                    <div>
                        <label
                            style="display: block; color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">PROBABILIDAD
                            (%)</label>
                        <input type="number" id="shining-prob-input" class="form-row input" style="width: 80px;" min="0"
                            max="100" step="0.1" value="1.0">
                    </div>
                    <div>
                        <label style="display: block; color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">L√çMITE DE
                            PODER BASE</label>
                        <input type="number" id="max-power-input" class="form-row input" style="width: 80px;" min="1"
                            max="1000" value="50">
                    </div>
                    <div>
                        <label style="display: block; color: #888; font-size: 0.8rem; margin-bottom: 0.5rem;">L√çMITE
                            GLOBAL (Personajes)</label>
                        <input type="number" id="global-char-limit-input" class="form-row input" style="width: 80px;"
                            min="1" max="50" value="3">
                    </div>
                </div>
                <div style="text-align: right;">
                    <button class="btn btn-small" onclick="saveCampaignGeneralSettings()">Guardar Configuraci√≥n</button>
                </div>
            </div>

            <div class="card">
                <h2>Gesti√≥n de Pistoleros</h2>
                <p style="color: #888; margin-bottom: 2rem;">Controla cu√°ntos personajes vivos puede tener cada
                    participante.</p>
                <div id="limit-management-list" class="participant-list">
                    <!-- Din√°mico -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Personaje (Creaci√≥n/Edici√≥n B√°sica / Ajustes) -->
    <div id="char-modal" class="modal">
        <div class="modal-content">
            <h2 id="char-modal-title">NUEVO PERSONAJE</h2>
            <form id="char-form">
                <input type="hidden" id="char-id">
                <div class="form-row">
                    <label>Nombre</label>
                    <input type="text" id="char-name" required>
                </div>
                <div class="form-row admin-only" id="owner-row">
                    <label>Asignar a Usuario (Due√±o)</label>
                    <select id="char-user-select">
                        <!-- Cargado din√°micamente con participantes -->
                    </select>
                </div>
                <div class="form-row">
                    <label>Descripci√≥n inicial</label>
                    <textarea id="char-description" rows="3"></textarea>
                </div>
                <div id="admin-controls" class="admin-only"
                    style="margin-top: 1.5rem; border-top: 1px solid #333; padding-top: 1rem; display: none;">
                    <label style="color: var(--accent); display: block; margin-bottom: 0.5rem;">CONTROLES DEL
                        MAESTRO</label>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button type="button" class="btn btn-small" id="kill-btn"
                            onclick="adminUpdateCondition('muerte')" style="border-color: #900;">Matar</button>
                        <button type="button" class="btn btn-small" id="revive-btn"
                            onclick="adminUpdateCondition('vivo')" style="border-color: #090;">Revivir</button>
                        <button type="button" class="btn btn-small" id="transcend-btn"
                            onclick="adminUpdateCondition('trascendido')"
                            style="border-color: #ffeb3b; color: #ffeb3b;">Trascender</button>
                        <button type="button" class="btn btn-small" onclick="deletePermanent()"
                            style="border-color: #f44; color: #f44; margin-left: auto;">ELIMINAR PERMANENTE</button>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                    <button type="button" onclick="closeModal('char-modal')" class="btn"
                        style="border-color: #555; color: #888;">Cerrar</button>
                    <button type="submit" class="btn">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Detailed Character Sheet -->
    <div id="detailed-sheet" class="detailed-sheet">
        <div class="sheet-header">
            <div>
                <h2 id="sheet-char-name" style="font-family: 'Metamorphous', cursive; color: var(--accent); margin: 0;">
                </h2>
                <div id="sheet-owner" style="font-size: 0.8rem; color: #888;">Controlado por: <span>...</span></div>
            </div>
            <button onclick="closeDetailedSheet()" class="btn" style="border-color: #555; color: #888;">Cerrar</button>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>HISTORIA / DESCRIPCI√ìN</h3>
                <div>
                    <button id="edit-desc-btn" class="btn btn-small" onclick="toggleEditDesc()">üî® Editar</button>
                    <button id="request-death-btn" class="btn btn-small" onclick="requestDeath()"
                        style="border-color: #666; color: #666;">üíÄ Solicitar Matar</button>
                </div>
            </div>
            <textarea id="sheet-desc"
                style="width: 100%; background: transparent; border: none; color: #ccc; font-family: inherit; resize: vertical; min-height: 100px; padding: 0.5rem;"
                readonly></textarea>
        </div>

        <div class="card" id="sheet-skills-card" style="margin-top: 1rem;">
            <h3>TAGS / HABILIDADES DEL RESPLANDOR</h3>
            <div id="sheet-skills" style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
                <!-- Tags here -->
            </div>
        </div>

        <div class="stats-grid" id="sheet-stats" style="margin-top: 1rem;">
            <!-- Stats will be loaded here: Vida Max, Vida, Fuerza, etc. -->
        </div>

        <div class="card" style="margin-top: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Condiciones Acad√©micas y F√≠sicas</h3>
                <button onclick="openConditionsModal()" class="btn btn-small"
                    style="border-color: #ff9800; color: #ff9800;">Ver Todos</button>
            </div>
            <div id="quick-conditions" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
                <!-- Short list of main conditions -->
            </div>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1.5rem; margin-bottom: 2rem;">
            <button id="roll-stats-btn" onclick="rollRandomStats()" class="btn" style="flex: 1;">Stats
                Aleatorios</button>
            <button id="roll-shining-btn" onclick="openShiningMachine()" class="btn"
                style="flex: 1; border-color: #4a148c; color: #9c27b0;">M√°quina del Resplandor</button>
        </div>

        <div class="inventory-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>Inventario</h3>
                <button onclick="addItem()" class="btn btn-small">A√±adir √çtem</button>
            </div>
            <div id="item-list" class="item-list">
                <!-- Items here -->
            </div>
        </div>

        <div style="margin-top: 3rem; text-align: right;">
            <button onclick="saveSheetData()" class="btn" id="save-all-btn">Guardar Cambios</button>
        </div>
    </div>

    <!-- Modals for Shining Machine (Simulated) -->
    <div id="shining-machine-modal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <h2 style="color: #9c27b0;">EL RESPLANDOR</h2>
            <div id="shining-results" style="margin-top: 1rem;">
                <!-- Results from index.js logic -->
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid #333;">Rango</th>
                            <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid #333;">Habilidad</th>
                            <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid #333;">Efecto</th>
                        </tr>
                    </thead>
                    <tbody id="shining-list"></tbody>
                </table>
            </div>
            <div style="margin-top: 2rem; text-align: right;">
                <button onclick="closeModal('shining-machine-modal')" class="btn">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Modal for Conditions -->
    <div id="conditions-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <h2 style="color: #ff9800;">ESTADO DEL PISTOLERO</h2>
            <div id="conditions-list" style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.8rem;">
                <!-- Detailed conditions list -->
            </div>
            <div style="margin-top: 2rem; text-align: right;">
                <button onclick="closeModal('conditions-modal')" class="btn">Cerrar</button>
            </div>
        </div>
    </div>

    <script src="campaign_dashboard.js"></script>
</body>

</html>